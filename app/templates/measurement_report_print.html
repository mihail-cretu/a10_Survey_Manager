<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Measurement Report {{ survey.name }} - {{ measurement.title }} - {{ survey.code or '' }}</title>
  <style>
    :root {
      --text: #1f2328;
      --muted: #475569;
      --border: #d0d7de;
      --accent: #0f172a;
      --good: #0f5132;
      --warn: #8a4b0f;
      --poor: #842029;
      --bad: #7f1d1d;
      --unusable: #0f172a;
    }
    @page {
      margin: 20mm;
    }
    * {
      box-sizing: border-box;
    }
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      font-size: 12px;
      color: var(--text);
      background: #fff;
    }
    header, footer {
      width: 100%;
      margin-bottom: 12px;
    }
    main {
      width: 100%;
    }
    h1 { font-size: 24px; margin: 0 0 8px 0; }
    h2 { font-size: 18px; margin: 28px 0 12px 0; }
    h3 { font-size: 15px; margin: 18px 0 8px 0; }
    p { margin: 0 0 6px 0; }
    .muted { color: var(--muted); }
    .section { page-break-inside: avoid; margin-bottom: 24px; }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px 16px;
      border: 1px solid var(--border);
      padding: 12px;
      border-radius: 8px;
    }
    .summary-grid div { display: flex; justify-content: space-between; }
    .summary-grid span.label { font-weight: 600; }
    .metric-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .metric-card {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
    }
    .metric-card .label { font-weight: 600; margin-bottom: 4px; }
    .metric-card .value { font-size: 20px; font-weight: 600; }
    .metric-card.status-good { border-color: #a3e4c9; }
    .metric-card.status-warn { border-color: #fcd34d; }
    .metric-card.status-poor { border-color: #fca5a5; }
    .metric-card.status-bad { border-color: #f87171; }
    .metric-card.status-unusable { border-color: #94a3b8; }
    .metric-card .status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .metric-card.status-good .status { color: var(--good); }
    .metric-card.status-warn .status { color: var(--warn); }
    .metric-card.status-poor .status { color: var(--poor); }
    .metric-card.status-bad .status { color: var(--bad); }
    .metric-card.status-unusable .status { color: var(--unusable); }
    .quality-indicator {
      display: inline-flex;
      width: 60px;
      height: 8px;
      border-radius: 999px;
      overflow: hidden;
      background: repeating-linear-gradient(
        to right,
        rgba(15, 23, 42, 0.15),
        rgba(15, 23, 42, 0.15) 10px,
        transparent 10px,
        transparent 12px
      );
      position: relative;
    }
    .quality-indicator::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
    }
    .quality-indicator.quality-good::after {
      background: linear-gradient(to right, #15803d 0%, #22c55e 100%);
    }
    .quality-indicator.quality-warn::after {
      background: linear-gradient(to right, #b45309 0%, #f97316 50%, rgba(249, 115, 22, 0.35) 50%);
    }
    .quality-indicator.quality-poor::after {
      background: linear-gradient(to right, #b91c1c 0%, #ef4444 45%, rgba(239, 68, 68, 0.35) 45%);
    }
    .quality-indicator.quality-bad::after {
      background: linear-gradient(to right, #7f1d1d 0%, #dc2626 60%, rgba(220, 38, 38, 0.35) 60%);
    }
    .quality-indicator.quality-unusable::after {
      background: linear-gradient(to right, #0f172a 0%, #1f2937 100%);
    }
    .detail-table {
      width: 100%;
      border: 1px solid var(--border);
      border-collapse: collapse;
      margin-top: 8px;
    }
    .detail-table th,
    .detail-table td {
      text-align: left;
      border-bottom: 1px solid var(--border);
      padding: 6px 10px;
      vertical-align: top;
    }
    .detail-table th { width: 220px; font-weight: 600; }
    .detail-table tr:last-child td,
    .detail-table tr:last-child th { border-bottom: none; }
    table.dataset {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid var(--border);
      margin-top: 10px;
      font-size: 11px;
    }
    table.dataset th,
    table.dataset td {
      border-bottom: 1px solid var(--border);
      padding: 6px 8px;
      text-align: left;
    }
    table.dataset th { background: #f8fafc; }
    .attachments ul { margin: 0; padding-left: 18px; }
    .media-primary {
      margin-top: 12px;
      text-align: center;
    }
    .media-primary img {
      max-width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: zoom-in;
    }
    .media-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .media-gallery figure {
      margin: 0;
      border: 1px solid var(--border);
      padding: 6px;
      border-radius: 8px;
      text-align: center;
    }
    .media-primary p,
    .media-gallery figcaption {
      margin-top: 6px;
      overflow-wrap: anywhere;
      word-break: break-word;
    }
    .media-gallery img {
      max-width: 100%;
      border-radius: 6px;
      cursor: zoom-in;
    }
    .image-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 9999;
    }
    .image-modal.active { display: flex; }
    .image-modal__content {
      max-width: 95vw;
      max-height: 90vh;
      position: relative;
    }
    .image-modal__image {
      max-width: 100%;
      max-height: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      box-shadow: 0 12px 48px rgba(15, 23, 42, 0.3);
    }
    .image-modal__caption {
      margin-top: 10px;
      text-align: center;
      color: #f1f5f9;
    }
    .image-modal__close {
      position: absolute;
      top: -12px;
      right: -12px;
      background: #0f172a;
      color: #fff;
      border: none;
      border-radius: 999px;
      width: 32px;
      height: 32px;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.3);
    }
    .image-modal__close:focus-visible {
      outline: 2px solid #cbd5f5;
      outline-offset: 2px;
    }
    .checklist-section { page-break-inside: avoid; }
    .checklist-stage { margin-bottom: 14px; }
    .signature-block {
      margin-top: 40px;
      border-top: 1px solid var(--border);
      padding-top: 12px;
    }
    .signature-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 24px;
    }
    .signature-line {
      border-bottom: 1px solid var(--border);
      margin-top: 32px;
      padding-bottom: 4px;
    }
    footer {
      margin-top: 36px;
      border-top: 1px solid var(--border);
      padding-top: 8px;
      font-size: 10px;
      color: var(--muted);
    }
    @media print {
      body { font-size: 11px; }
      .section { page-break-inside: avoid; }
      .page-break { page-break-before: always; }
    }
  </style>
</head>
<body>
<header>
  {% if header_html %}
    {{ header_html | safe }}
  {% endif %}
</header>
<main>
  <section class="section">
    <h1>Gravity Measurement Report</h1>
    <p class="muted">Generated {{ generated_at }}</p>
    <div class="summary-grid" style="margin-top:12px;">
      {% for label, value in summary_items %}
        {% if value %}
        <div>
          <span class="label">{{ label }}</span>
          <span>{{ value }}</span>
        </div>
        {% endif %}
      {% endfor %}
    </div>
  </section>

  <section class="section">
    <h2>Measurement Quality Summary</h2>
    <div class="metric-cards">
      {% for metric in metrics %}
        <div class="metric-card status-{{ metric.status }}">
          <div class="label">{{ metric.label }}</div>
          <div class="value">
            {% if metric.value is not none %}
              {% if metric.label in ['Final Determined Gravity'] %}
                
			        {% else %}
                &PlusMinus;
              {% endif %}
              {{ '%.3f' % metric.value }}{% if metric.unit %} {{ metric.unit }}{% endif %}
            {% else %}
              &mdash;
            {% endif %}
          </div>
          {% if metric.status in ['good','warn','poor','bad','unusable'] %}
            <div class="status">
              <span>{{ metric.status|upper }}</span>
              {% if metric.value is not none and metric.value != 0 %}
                <span class="quality-indicator quality-{{ metric.status }}" aria-hidden="true"{% if metric.tooltip %} title="{{ metric.tooltip }}"{% endif %}></span>
              {% endif %}
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </section>

  <section class="section">
    <h2>Survey Overview</h2>
    <table class="detail-table">
      {% for label, value in site_details %}
        {% if value and value != '-' %}
        <tr>
          <th>{{ label }}</th>
          <td>{{ value }}</td>
        </tr>
        {% endif %}
      {% endfor %}
    </table>
  </section>

  <section class="section">
    <h2>Totals &amp; Acquisition Details</h2>
    <table class="detail-table">
      {% for label, value in totals_details %}
        {% if value and value != '-' %}
        <tr><th>{{ label }}</th><td>{{ value }}</td></tr>
        {% endif %}
      {% endfor %}
    </table>
  </section>

  {% if set_rows %}
  <section class="section page-break">
    <h2>Per-Set Results</h2>
    <table class="dataset">
      <thead>
        <tr>
          <th>Set #</th>
          <th>Set Scatter (&micro;Gal)</th>
          <th>Set Sigma</th>
          <th>Drop RMS</th>
          <th>Acceptance %</th>
          <th>Drops</th>
        </tr>
      </thead>
      <tbody>
        {% for row in set_rows %}
        <tr>
          <td>{{ row.id }}</td>
          <td>{{ row.set_scatter if row.set_scatter is not none else '&mdash;' }}</td>
          <td>{{ row.set_sigma if row.set_sigma is not none else '&mdash;' }}</td>
          <td>{{ row.drop_rms if row.drop_rms is not none else '&mdash;' }}</td>
          <td>{{ row.drop_acc_ratio if row.drop_acc_ratio is not none else '&mdash;' }}</td>
          <td>{{ row.drop_accept|int if row.drop_accept is not none else '&mdash;' }}A / {{ row.drop_reject|int if row.drop_reject is not none else '&mdash;' }}R</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
  {% endif %}

  <section class="section">
    <h2>Attachments</h2>
    {% if attachments %}
    <div class="attachments">
      <ul>
        {% for att in attachments %}
          <li>
            <strong>{{ att.label }}:</strong>
            <a href="{{ att.download_url }}" download="{{ att.filename }}">{{ att.filename }}</a>
            {% if att.note %}<span class="muted">({{ att.note }})</span>{% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>
    {% else %}
      <p class="muted">No supporting files recorded.</p>
    {% endif %}
  </section>

  {% if primary_image %}
  <section class="section">
    <h2>Site Images</h2>
    <div class="media-primary">
      {% set primary_caption = primary_image.caption %}
      {% if not primary_caption %}
        {% set _primary_base = primary_image.filename.rsplit('.', 1)[0] %}
        {% if survey.name %}
          {% set _primary_base = _primary_base.replace(survey.name, '') %}
        {% endif %}
        {% set _primary_trimmed = _primary_base.strip(' _-') %}
        {% set primary_caption = _primary_trimmed if _primary_trimmed else _primary_base %}
      {% endif %}
      <img src="{{ primary_image.data_url }}" alt="{{ primary_image.filename }}" data-enlarge="true" data-caption="{{ primary_caption }}">
      <p class="muted">{{ primary_caption }}</p>
    </div>
    {% if gallery_images %}
    <div class="media-gallery">
      {% for img in gallery_images %}
      {% set gallery_caption = img.caption %}
      {% if not gallery_caption %}
        {% set _gallery_base = img.filename.rsplit('.', 1)[0] %}
        {% if survey.name %}
          {% set _gallery_base = _gallery_base.replace(survey.name, '') %}
        {% endif %}
        {% set _gallery_trimmed = _gallery_base.strip(' _-') %}
        {% set gallery_caption = _gallery_trimmed if _gallery_trimmed else _gallery_base %}
      {% endif %}
      <figure>
        <img src="{{ img.data_url }}" alt="{{ img.filename }}" data-enlarge="true" data-caption="{{ gallery_caption }}">
        <figcaption>{{ gallery_caption }}</figcaption>
      </figure>
      {% endfor %}
    </div>
    {% endif %}
  </section>
  {% endif %}

  {% if graph_images or graph_docs %}
  <section class="section">
    <h2>g9 Graphs</h2>
    {% if graph_images %}
    <div class="media-gallery">
      {% for gr in graph_images %}
      {% set graph_caption = gr.note %}
      {% if not graph_caption %}
        {% set _graph_base = gr.filename.rsplit('.', 1)[0] %}
        {% if survey.name %}
          {% set _graph_base = _graph_base.replace(survey.name, '') %}
        {% endif %}
        {% set _graph_trimmed = _graph_base.strip(' _-') %}
        {% set graph_caption = _graph_trimmed if _graph_trimmed else _graph_base %}
      {% endif %}
      <figure>
        <img src="{{ gr.data_url }}" alt="{{ gr.filename }}" data-enlarge="true" data-caption="{{ graph_caption }}">
        <figcaption>{{ graph_caption }}</figcaption>
      </figure>
      {% endfor %}
    </div>
    {% endif %}
    {% if graph_docs %}
    <div class="attachments" style="margin-top:12px;">
      <ul>
        {% for doc in graph_docs %}
        <li><strong>Graph Document:</strong> <a href="{{ doc.data_url }}" download="{{ doc.filename }}">{{ doc.filename }}</a> {% if doc.note %}<span class="muted">({{ doc.note }})</span>{% endif %}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
  </section>
  {% endif %}

  {% if checklist_stages %}
  <section class="section page-break checklists">
    <h2>Checklist Summary</h2>
    {% for stage in checklist_stages %}
      <div class="checklist-stage">
        <h3>{{ stage.title }}</h3>
        <table class="dataset">
          <thead>
            <tr>
              <th>Step</th>
              <th>Instruction</th>
              <th>Recorded Value</th>
              <th>Expected</th>
            </tr>
          </thead>
          <tbody>
            {% for row in stage.entries %}
            <tr>
              <td>{{ row.step }}</td>
              <td>{{ row.action }}</td>
              <td>{{ row.value }}</td>
              <td>{{ row.expected }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endfor %}
  </section>
  {% endif %}

  <section class="section signature-block">
    <h2>Sign-off</h2>
    <div class="signature-grid">
      <div>
        <div class="signature-line"></div>
        <p class="muted">Reviewed by</p>
      </div>
      <div>
        <div class="signature-line"></div>
        <p class="muted">Date</p>
      </div>
    </div>
  </section>
</main>
<footer>
  {% if footer_html %}
    {{ footer_html | safe }}
  {% else %}
    <p class="muted">Generated by Site Survey Manager - {{ generated_at }}</p>
  {% endif %}
</footer>

<div id="image-modal" class="image-modal" aria-hidden="true">
  <div class="image-modal__content" role="dialog" aria-modal="true" aria-labelledby="image-modal-caption">
    <button type="button" class="image-modal__close" data-modal-close aria-label="Close image">&times;</button>
    <img class="image-modal__image" src="" alt="Expanded view">
    <p id="image-modal-caption" class="image-modal__caption"></p>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('image-modal');
    if (!modal) { return; }

    const modalImage = modal.querySelector('.image-modal__image');
    const modalCaption = modal.querySelector('.image-modal__caption');
    const closeButton = modal.querySelector('[data-modal-close]');

    const openModal = (src, altText, caption) => {
      modalImage.src = src;
      modalImage.alt = altText || 'Expanded view';
      modalCaption.textContent = caption || altText || '';
      modal.classList.add('active');
      modal.setAttribute('aria-hidden', 'false');
      if (closeButton) {
        closeButton.focus({ preventScroll: true });
      }
    };

    const closeModal = () => {
      if (!modal.classList.contains('active')) { return; }
      modal.classList.remove('active');
      modal.setAttribute('aria-hidden', 'true');
      modalImage.src = '';
      modalImage.alt = 'Expanded view';
    };

    document.querySelectorAll('img[data-enlarge="true"]').forEach((img) => {
      img.addEventListener('click', () => {
        openModal(img.src, img.alt, img.getAttribute('data-caption'));
      });
    });

    modal.addEventListener('click', (event) => {
      if (event.target === modal || event.target === closeButton) {
        closeModal();
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeModal();
      }
    });
  });
</script>
</body>
</html>
